---
title: "analysis"
author: "Paul Melloy"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(RANN) # nearest neighbour
library(flextable)
library(officer)
library(data.table)
library(ggplot2)
library(mgcv) # gam models
library(cercospoRa)
```

### Read in data
```{r read_data}
cclo <- fread("../data/20250608_cercospoRa_analysis_df_cc(in).csv")[, "data" := "canopy_closure"]
eeeo <- fread("../data/20250607_cercospoRa_analysis_df.csv")[, "data" := "epidemic_onset"]
```

We will combine the data so we can associate observation locations with canopy 
closure locations.  

### Inspect data
#### Check headings
```{r inspect_data_headings}
colnames(cclo)
colnames(eeeo)
```

We need to change the headings so they have the same names and join them.

### Rename variables  
```{r rename_cols}
setnames(cclo,
         old = c("cc","region","treatment"),
         new = c("das","inoculum","fungicide"))

setnames(eeeo,
         old = c("region","treatment"),
         new = c("inoculum","fungicide"))

# Remove date column
eeeo[, date := NULL]
```

```{r join}
dat <- rbind(cclo,eeeo)
```


```{r rename_vars}
unique(dat$fungicide)

unique(dat$inoculum)
dat[inoculum == "roi", inoculum := "non-inoculated"]
dat[inoculum == "ino", inoculum := "inoculated"]

unique(dat$source)
dat[source == "uav", source := "uas"]


# Relevel fungicide factor
dat[,fungicide := factor(fungicide, levels = c("untreated", "treated"))]
dat[,inoculum := factor(inoculum, levels = c("non-inoculated", "inoculated"))]
```



### Get nearest neighbour
Associate the closest observed epidemic onset date (EO) to the UAS or S2 
Earliest Estimated Epidemic Onset (EEEO) date.  

```{r nearest_neighbour}
obs_nearest <- nn2(data = dat[source == "observation",.(x,y)],
                   query = dat[,.(x,y)],
                   k = 2)

range(obs_nearest$nn.idx[,1])

# associate RS estimated EO with closest observation
dat[, obs_das:= dat[source == "observation",das][obs_nearest$nn.idx[,1]]]
```

## Canopy Closure  

```{r subset_cclo}
cclo <- dat[data == "canopy_closure"]
```


Do a quick check on aov of the data to inspect average differences between 
inoculation and fungicide treatments.

```{r lm_check}
# check variance averages 
mod <- lm(das ~ source + inoculum + fungicide, data = cclo)
summary(mod)
```

### Plot data
```{r plot_data}
# plot EO data from each source an treatment
cclo |>
  ggplot(aes(source,das, fill = inoculum)) +
  geom_boxplot() +
  facet_wrap(~fungicide) +
  theme_bw() +
  labs(x = "Remote sensing platform",
       y = "Canopy Closure in days after sowing") +
  theme(legend.position = "top")+
  scale_fill_viridis_d()
```

### Model data  

#### Model 1  

> What are the average influences independent of other treatments accounting for
spatial variability?  

We will use Generalized Additive Models (GAM) to model the data, adding a spline
to account for the spatial variance across the field.  

```{r model_data1}
# what are the average influences independant of other treatments
mod1 <- gam(das ~ s(x,y) + source + inoculum + fungicide,
          data = cclo,
          method = "REML")
summary(mod1)
```

Check the spline fit to ensure no over fitting.  
```{r spline_fit1}
plot(mod1)
```

There seems an overfitting due to the experimental setup.
The spatial spline is accounting for too much of the inoculated areas.  

We will try again refitting with less knots.  

```{r model_data1a}
# what are the average influences independant of other treatments
mod1a <- gam(das ~ s(x,y, k=11) + source + inoculum + fungicide,
          data = cclo,
          method = "REML")
```

Check the spline fit to ensure no over fitting.  

```{r spline_fit1a}
plot(mod1a)
```

With fewer knots we have obtained a spatial correction for the field gradient.

Fungicide treated areas on average were not significantly different to untreated
for epidemic onset days.  

Non-Inoculated areas on average show earlier canopy closure, compared to 
inoculated areas.  

Remote sensing platform UAS detects average canopy closure 12 days earlier

#### Model 3  

> Is there a significant interaction between measurement source and inoculum?  

```{r model_data2}
mod2 <- gam(das ~ s(x,y, k = 11) + source * inoculum + fungicide,
            data = cclo,
            method = "REML")
summary(mod2)
```

There is no significant interaction in inoculated areas and canopy closure dates
from different platforms.  

#### Model 3  

> Inoculum and fungicide interaction?  

```{r model_data3}
mod3 <- gam(das ~ s(x,y, k = 11) + source + inoculum * fungicide,
            data = cclo)
summary(mod3)
```

There is no significant interaction, however it seems close.  

#### Model 4  

> Is there a interaction between RS source and fungicide?  

```{r model_data4}
mod4 <- gam(das ~ s(x,y, k = 11) + source * fungicide + inoculum,
            data = cclo)
summary(mod4)
```


### Fungicide treatment  

Overall there was no significant effects of fungicide treated part of the field.
The only significant result showed remote sensing methods S2 and UAS resulted in
earlier EEEO dates in fungicide treated compared to untreated.  
The fungicide treated area seemed to show thicker canopy and I think this result
can be put down to spatial field effects.  

#### Model 5  
Therefore the fungicide variable will be removed and this area treated as a 
field replicate.  

> Is there an interaction between RS platform and inoculated areas on canopy 
closure?  

```{r model_data5}
mod5 <- gam(das ~ s(x,y, k = 7) + source * inoculum,
            data = cclo[fungicide == "untreated"])
summary(mod5)
```

There is no canopy closure timing interaction between remote sensing platform 
and inoculated areas.  

#### Model 6  

```{r model_data6}
mod6 <- gam(das ~ s(x,y, k = 7) + source + inoculum,
            data = cclo[fungicide == "untreated"])
summary(mod6)
```


##### Intercept  
The intercept here represents:
 > Canopy closure dates in inoculated areas determined by sentinal-2  

and averages around `r interpret_gam(mod6, words = 0)` days
`r interpret_gam(mod6, words = 4)` sowing.  
  
##### Remote sensing variables  
UAS estimated epidemic onset an average of 
`r interpret_gam(mod6, words = 0, coeff = "sourceuas")` days 
`r interpret_gam(mod6, words = 5, coeff = "sourceuas")`than Sentinal 2.  

##### Inoculation effect

Non-inoculated areas were on average 
`r rinterpret_gam(mod6, words = 0, coeff = "inoculumnon-inoculated"` days 
`r rinterpret_gam(mod6, words = 5, coeff = "inoculumnon-inoculated"` 
than inoculated areas.  

As shown in mod5 there is no interactive effect of source, indicating both 
remote sensing platforms showed inoculated areas had retarded phenology.

##### Spatial effect  
```{r}
plot(mod6)
```



Model comparisons

```{r}
anova(mod5,mod6)
```

No significant difference, use simpler model mod6.  

***  

## Epidemic Onset  


```{r subset_eeeo}
eeeo <- dat[data == "epidemic_onset"]
```

### Plot data
```{r plot_data}
# plot EO data from each source an treatment
library(ggplot2)
eeeo[source != "observation",] |>
  ggplot(aes(x = obs_das, y = das, color = inoculum)) +
   geom_point(size = 4,alpha = .5,shape = 16) +
  facet_wrap(~fungicide + source) +
  theme_bw() +
  labs(title = "Epidemic onset by spatial location",
       x = "Observation",
       y = "UAS Estimated earliest EO") +
  theme(legend.position = "top")+
  xlim(c(90,180))+
  ylim(c(90,180))+
  geom_abline(slope = 1, intercept = 0, color = "black", linetype = "dashed")+
  scale_color_viridis_d()
```

### Model data  

#### Model 1  

> What are the average influences independent of other treatments?  

We will use Generalized Additive Models (GAM) to model the data, adding a spline
to account for the spatial location of the data.  

```{r eo_model_data1}
# what are the average influences independant of other treatments
mod1_eo <- gam(das ~ s(x,y) + source + inoculum + fungicide,
          data = eeeo,
          method = "REML")
summary(mod1_eo)
```

Fungicide treated areas on average were not significantly different to untreated
for epidemic onset days.  

#### check spatial fit  

```{r eo_spatial_fit}
plot(mod1_eo)
```

This looks slightly over fit. 
We should use fewer knots.  

#### Model 2  


```{r eo_mod2}
mod2_eo <- gam(das ~ s(x,y, k = 8) + source + inoculum + fungicide,
          data = eeeo,
          method = "REML")
plot(mod2_eo)
```

#### Model 3  

> Is there a significant interaction between measurement source and inoculum?  

```{r eo_model_data3}
mod3_eo <- gam(das ~ s(x,y, k = 8) + source * inoculum + fungicide,
            data = eeeo,
            method = "REML")
summary(mod3_eo)
```

There is a significant interaction in inoculated areas observed epidemic onset 
was not significantly different to S2 earliest estimated epidemic onset dates.  

#### Model 4  


> Three-way interaction?  

```{r eo_model_data4}
mod4_eo <- gam(das ~ s(x,y, k = 8) + source * inoculum * fungicide,
            data = eeeo)
summary(mod4_eo)
```

### Drop Fungicide Treatment  

The fungicide variable will be removed, initially I will test the model 
using fungicide as field replicate, then drop fungicide treated areas from the 
analysis.  

#### Model 5  

```{r eo_model_data5}
mod5_eo <- gam(das ~ s(x,y, k =8) + source * inoculum,
            data = eeeo)
summary(mod5_eo)
```

##### Intercept  
The intercept here represents:  
 > Observed EO dates in non-inoculated areas  

and averages around `r interpret_gam(mod5_eo, 0)` days 
`r interpret_gam(mod5_eo, 4)` sowing.  
  
#### Remote sensing variables  
Sentinel 2 estimated epidemic onset an average of 
`r interpret_gam(mod5_eo, 0,"sources2")` days 
`r interpret_gam(mod5_eo, 5,"sources2")` than observed EO.  

UAS estimated epidemic onset an average of 
`r interpret_gam(mod5_eo, 0,"sourceuas")` days 
`r interpret_gam(mod5_eo, 5,"sources2")` than observed EO.  

#### Inoculation effect

Observed EO dates within inoculated areas were on average 
`r interpret_gam(mod5_eo, 0,"inoculumino")` days 
`r interpret_gam(mod5_eo, 5,"inoculumino")` 
days earlier than non-inoculated areas.  

However EEEO dates in inoculated areas produced by remote sensing methods 
S2 and UAS were
`r interpret_gam(mod5_eo, 0,"sources2:inoculuminoculated")` and 
`r interpret_gam(mod5_eo, 0,"sourceuav:inoculumino")` days 
`r interpret_gam(mod5_eo, 5,"sourceuas:inoculuminoculated")` than the observed EO days.  

#### spatial effect  

```{r mod5_spatial}
plot(mod5_eo)
```

```{r eo_model_data6}
mod6 <- gam(das ~ s(x,y, k = 8) + source * inoculum,
            data = eeeo[fungicide != "treated"])
summary(mod5a)
```
#### Intercept  
The intercept here represents:
 > Observed EO dates in non-inoculated areas  

and averages around `r round(unname(mod5a$coefficients["(Intercept)"]),2)` days
after sowing.  
  
#### Remote sensing variables  
Sentinel 2 estimated epidemic onset an average of `r round(unname(mod5a$coefficients["sources2"]),2)`
days earlier than observed EO.  

UAS estimated epidemic onset an average of `r round(unname(mod5a$coefficients["sourceuav"]),2)`
days earlier than observed EO.  

#### Inoculation effect

Observed EO dates within inoculated areas were on average `r round(unname(mod5a$coefficients["inoculumino"]),2)`
days earlier than non-inoculated areas.  

However EEEO dates in inoculated areas produced by remote sensing methods S2 and UAS were
`r round(unname(mod5a$coefficients["sources2:inoculumino"]),2)` and 
`r round(unname(mod5a$coefficients["sourceuav:inoculumino"]),2)` days later than
the observed EO days.  

#### spatial effect  
```{r}
plot(mod5a)
```


Model comparisons

```{r}
# AIC(mod2,
#     mod3,
#     mod4,
#     mod5)
# anova(mod4,mod5)
```


### Proportional successes 

> What is the proportion of observed EO occuring later than EEEO?  

This should show us how successful the negative prognosis model is

```{r prop_success_dens}
tbl_prop_success <- 
    eeeo[source != "observation" & fungicide != "treated", 
      list("prop_success" = round(sum(das < obs_das)/NROW(das),3),
           n = .N), 
      by = .(source, inoculum, fungicide)][,.(source,
                                              inoculum,
                                              n,
                                              prop_success)] |>
  flextable() |>
  align_text_col(align = "center") |>
  set_header_labels(source = "RS method",
                    inoculum = "Inoculum",
                    prop_success = "∝ success") |>
   fontsize(size = 8, part = "body") |>
   fontsize(size = 10, part = "header") |>
   bg(i = seq(2,5,2),bg = "grey80",part = "body")|>
   set_caption("Proportion of RS earliest estimated onset dates occurring prior to observed epidemic onset")

tbl_prop_success
#save_as_docx(tbl_prop_success, path = "./prop_success.docx")
```


Lets visualise the densities of the observed and estimated epidemic onset dates

```{r prop_success}
eeeo[, obs_dif := das - obs_das]

eeeo[source != "observation"] |>
  ggplot(aes(x = obs_dif, fill = inoculum)) +
  geom_density(alpha = .5) +
  facet_wrap(~source + fungicide) +
  theme_bw() +
  labs(x = "Difference between observed EO and Earliest estimated EO",
       y = "Density") +
  theme(legend.position = "top")+
  scale_fill_viridis_d()+
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1)

```




