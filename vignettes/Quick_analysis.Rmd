---
title: "analysis"
author: "Paul Melloy"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(RANN)
library(flextable)
library(officer)
library(data.table)
```

### Read in data
```{r read_data}
dat <- fread("../data/20250607_cercospoRa_analysis_df.csv")
```

### Inspect data
```{r inspect_data}
head(dat)
summary(dat)
unique(dat$treatment)
unique(dat$region)
unique(dat$source)
```

### Rename variables  
```{r rename_data}
setnames(dat,
         old = c("region","treatment"),
         new = c("inoculum","fungicide"))
dat[inoculum == "roi", inoculum := "non_inoc"]

# Relevel fungicide factor
dat[,fungicide := factor(fungicide, levels = c("untreated", "treated"))]
dat[,inoculum := factor(inoculum, levels = c("non_inoc", "ino"))]
```

### Get nearest neighbour
Associate the closest observed epidemic onset date (EO) to the UAS or S2 
Earliest Estimated Epidemic Onset (EEEO) date.  

```{r nearest_neighbour}
obs_nearest <- nn2(data = dat[source == "observation",.(x,y)],
                   query = dat[,.(x,y)],
                   k = 2)

range(obs_nearest$nn.idx[,1])

# associate RS estimated EO with closest observation
dat[, obs_das:= dat[source == "observation",das][obs_nearest$nn.idx[,1]]]
```

Do a quick check on aov of the data to inspect average differences between 
inoculation and fungicide treatments.

```{r lm_check}
# check variance averages 
mod1 <- lm(das ~ source + inoculum + fungicide, data = dat)
summary(mod1)
```

### Plot data
```{r plot_data}
# plot EO data from each source an treatment
library(ggplot2)
dat[source != "observation",] |>
  ggplot(aes(x = obs_das, y = das, color = inoculum)) +
   geom_point(size = 4,alpha = .5,shape = 16) +
  facet_wrap(~fungicide + source) +
  theme_bw() +
  labs(title = "Epidemic onset by spatial location",
       x = "Observation",
       y = "UAS Estimated earliest EO") +
  theme(legend.position = "top")+
  xlim(c(90,180))+
  ylim(c(90,180))+
  geom_abline(slope = 1, intercept = 0, color = "black", linetype = "dashed")+
  scale_color_viridis_d()
```

### Model data  

> What are the average influences independent of other treatments?  

We will use Generalized Additive Models (GAM) to model the data, adding a spline
to account for the spatial location of the data.  

```{r model_data2}
library(mgcv)
# what are the average influences independant of other treatments
mod2 <- gam(das ~ s(x,y) + source + inoculum + fungicide,
          data = dat,
          method = "REML")
summary(mod2)
```

Fungicide treated areas on average were not significantly different to untreated
for epidemic onset days.  

> Is there a significant interaction between measurement source and inoculum?  

```{r model_data3}
mod3 <- gam(das ~ s(x,y) + source * inoculum + fungicide,
            data = dat,
            method = "REML")
summary(mod3)
```

There is a significant interaction in inoculated areas observed epidemic onset 
was not significantly different to S2 earliest estimated epidemic onset dates.  

> Three-way interaction?  

```{r model_data4}
mod4 <- gam(das ~ s(x,y) + source * inoculum,# * fungicide,
            data = dat[fungicide != "treated"])
summary(mod4)
```

#### fungicide treatment  

Overall there was no sigificant effects of fungicide treated part of the field.
The only significant result showed remote sensing methods S2 and UAS resulted in
earlier EEEO dates in fungicide treated compared to untreated.  
The fungicide treated area seemed to show thicker canopy and I think this result
can be put down to spatial field effects.  

Therefore the fungicide variable will be removed and this area treated as a 
field replicate.  

```{r model_data5}
mod5 <- gam(das ~ s(x,y) + source * inoculum,
            data = dat)
summary(mod5)
```
#### Intercept  
The intercept here represents:
 > Observed EO dates in non-inoculated areas  

and averages around `r round(unname(mod5$coefficients["(Intercept)"]),2)` days
after sowing.  
  
#### Remote sensing variables  
Sentinel 2 estimated epidemic onset an average of `r round(unname(mod5$coefficients["sources2"]),2)`
days earlier than observed EO.  

UAS estimated epidemic onset an average of `r round(unname(mod5$coefficients["sourceuav"]),2)`
days earlier than observed EO.  

#### Inoculation effect

Observed EO dates within inoculated areas were on average `r round(unname(mod5$coefficients["inoculumino"]),2)`
days earlier than non-inoculated areas.  

However EEEO dates in inoculated areas produced by remote sensing methods S2 and UAS were
`r round(unname(mod5$coefficients["sources2:inoculumino"]),2)` and 
`r round(unname(mod5$coefficients["sourceuav:inoculumino"]),2)` days later than
the observed EO days.  

#### spatial effect  
```{r}
plot(mod5)
```

Model comparisons

```{r}
AIC(mod2,
    mod3,
    mod4,
    mod5)
anova(mod4,mod5)
```


### Proportional successes 

> What is the proportion of observed EO occuring later than EEEO?  

This should show us how successful the negative prognosis model is

```{r prop_success}
tbl_prop_success <- 
    dat[source != "observation" & fungicide != "treated", 
      list("prop_success" = round(sum(das < obs_das)/NROW(das),3),
           n = .N), 
      by = .(source, inoculum, fungicide)][,.(source,
                                              inoculum,
                                              prop_success)] |>
  flextable() |>
  align_text_col(align = "center") |>
  set_header_labels(source = "RS method",
                    inoculum = "Inoculum",
                    prop_success = "∝ success") |>
   fontsize(size = 8, part = "body") |>
   fontsize(size = 10, part = "header") |>
   bg(i = seq(2,5,2),bg = "grey80",part = "body")|>
   set_caption("Proportion of RS earliest estimated onset dates occurring prior to observed epidemic onset")

tbl_prop_success
save_as_docx(tbl_prop_success, path = "./prop_success.docx")
```


Lets visualise the densities of the observed and estimated epidemic onset dates

```{r prop_success}
dat[, obs_dif := das - obs_das]

dat[source != "observation"] |>
  ggplot(aes(x = obs_dif, fill = inoculum)) +
  geom_density(alpha = .5) +
  facet_wrap(~source + fungicide) +
  theme_bw() +
  labs(x = "Difference between observed EO and Earliest estimated EO",
       y = "Density") +
  theme(legend.position = "top")+
  scale_fill_viridis_d()+
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 1)

```





